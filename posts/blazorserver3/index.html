<!DOCTYPE html>
<html><head>
<title>使用Blazor Server构建企业级应用(三) -- 使用Serilog记录和显示业务日志</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">











<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-224238665-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">


  






<link rel="stylesheet" href="http://www.nintens.com/scss/journal.min.3f72a5fc8f5b5dd732a4b476aced0eece2156958d9d414316494ddb10593ddf7.css" integrity="sha256-P3Kl/I9bXdcypLR2rO0O7OIVaVjZ1BQxZJTdsQWT3fc=" media="screen">



<link rel="stylesheet" href="http://www.nintens.com/scss/dark-mode.min.c0082f0b082177f6fb3768ff91439a097de49689bd26f4d49f76d94ebb81e02d.css" integrity="sha256-wAgvCwghd/b7N2j/kUOaCX3klom9JvTUn3bZTruB4C0=" media="screen">


<script src="/vendor/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>






  <script src="/js/toc.js"></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="/vendor/js/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
  clientID: '3231fec73fc43dd4bcc8',
  clientSecret: 'f8ac50ce92aca43790a03f6f576b02fdfe0eb0a8',
  repo: 'nintens.com',
  owner: 'liuguanglong',
  admin: ['liuguanglong'],
  id: md5(location.pathname),
  distractionFreeMode: 'false'
  });
  window.onload = function () {
        gitalk.render('gitalk-container')
  }
</script>











<script>console.log("Hello from 'layouts/partials/extended_head.html'")</script>

</head>
<body>
    	<div id="app"><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="http://www.nintens.com/">
    
        <div class="nav-title">
            Nintens&#39; Blogs 
        </div>
        
        <div class="nav-subtitle">
            应无所住而生其心
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Nintens@2022 Copywright
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bd%bf%e7%94%a8blazor-server%e6%9e%84%e5%bb%ba%e4%bc%81%e4%b8%9a%e7%ba%a7%e5%ba%94%e7%94%a8%e4%b8%89-%e4%bd%bf%e7%94%a8serilog%e8%ae%b0%e5%bd%95%e5%92%8c%e6%98%be%e7%a4%ba%e4%b8%9a%e5%8a%a1%e6%97%a5%e5%bf%97" onclick="onNavClick(`#使用blazor-server构建企业级应用三-使用serilog记录和显示业务日志-nav`)" id="使用blazor-server构建企业级应用三-使用serilog记录和显示业务日志-nav">
									使用Blazor Server构建企业级应用(三) 使用Serilog记录和显示业务日志
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%b8%80-serilog%e5%9f%ba%e7%a1%80%e9%85%8d%e7%bd%ae" onclick="onNavClick(`#一-serilog基础配置-nav`)" id="一-serilog基础配置-nav">
									一 Serilog基础配置
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%ba%8c-%e6%97%a5%e5%bf%97%e8%ae%b0%e5%bd%95%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae%e6%89%a9%e5%b1%95logcontext%e6%b7%bb%e5%8a%a0user%e5%92%8cip%e4%bf%a1%e6%81%af" onclick="onNavClick(`#二-日志记录高级配置扩展logcontext添加user和ip信息-nav`)" id="二-日志记录高级配置扩展logcontext添加user和ip信息-nav">
									二 日志记录高级配置，扩展logContext，添加User和IP信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%b8%89-%e4%b8%9a%e5%8a%a1%e6%97%a5%e5%bf%97%e5%ad%98%e5%82%a8%e6%96%b9%e6%a1%88" onclick="onNavClick(`#三-业务日志存储方案-nav`)" id="三-业务日志存储方案-nav">
									三 业务日志存储方案
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%80%bb%e7%bb%93" onclick="onNavClick(`#总结-nav`)" id="总结-nav">
									总结
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bd%bf%e7%94%a8blazor-server%e6%9e%84%e5%bb%ba%e4%bc%81%e4%b8%9a%e7%ba%a7%e5%ba%94%e7%94%a8%e4%b8%89-%e4%bd%bf%e7%94%a8serilog%e8%ae%b0%e5%bd%95%e5%92%8c%e6%98%be%e7%a4%ba%e4%b8%9a%e5%8a%a1%e6%97%a5%e5%bf%97" onclick="onNavClick(`#使用blazor-server构建企业级应用三-使用serilog记录和显示业务日志-nav`)" id="使用blazor-server构建企业级应用三-使用serilog记录和显示业务日志-nav">
									使用Blazor Server构建企业级应用(三) 使用Serilog记录和显示业务日志
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%b8%80-serilog%e5%9f%ba%e7%a1%80%e9%85%8d%e7%bd%ae" onclick="onNavClick(`#一-serilog基础配置-nav`)" id="一-serilog基础配置-nav">
									一 Serilog基础配置
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%ba%8c-%e6%97%a5%e5%bf%97%e8%ae%b0%e5%bd%95%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae%e6%89%a9%e5%b1%95logcontext%e6%b7%bb%e5%8a%a0user%e5%92%8cip%e4%bf%a1%e6%81%af" onclick="onNavClick(`#二-日志记录高级配置扩展logcontext添加user和ip信息-nav`)" id="二-日志记录高级配置扩展logcontext添加user和ip信息-nav">
									二 日志记录高级配置，扩展logContext，添加User和IP信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%b8%89-%e4%b8%9a%e5%8a%a1%e6%97%a5%e5%bf%97%e5%ad%98%e5%82%a8%e6%96%b9%e6%a1%88" onclick="onNavClick(`#三-业务日志存储方案-nav`)" id="三-业务日志存储方案-nav">
									三 业务日志存储方案
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%80%bb%e7%bb%93" onclick="onNavClick(`#总结-nav`)" id="总结-nav">
									总结
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="http://www.nintens.com/">
            Nintens&#39; Blogs 
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="http://www.nintens.com/">
        <div class="single-column-header-title">Nintens&#39; Blogs </div>
        
        <div class="single-column-header-subtitle">应无所住而生其心</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('http://www.nintens.com/images/chinese.jpg')"
                    
                
            >
                <div class="post-title">
                    使用Blazor Server构建企业级应用(三) -- 使用Serilog记录和显示业务日志
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2022-04-02 23:25
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/blazor">blazor</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/blazor-server">blazor server</a>
                                &nbsp;
                            
                                <a href="/tags/asp.net-core">asp.net core</a>
                                &nbsp;
                            
                                <a href="/tags/log">log</a>
                                &nbsp;
                            
                                <a href="/tags/mysql">mysql</a>
                                &nbsp;
                            
                                <a href="/tags/serilog">Serilog</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h2 id="使用blazor-server构建企业级应用三-使用serilog记录和显示业务日志">使用Blazor Server构建企业级应用(三) 使用Serilog记录和显示业务日志</h2>
<p>本文地址：http://www.nintens.com/posts/blazorserver3/<br>
作者邮箱：liuguanglong@yahoo.com<br>
欢迎转载，请在明显位置给出出处及链接</p>
<p>本文是nintens架构系列文章的第三篇，包含以下内容</p>
<ul>
<li>Serilog基本配置</li>
<li>Serilog logCentext扩展</li>
<li>业务日志记录方案</li>
</ul>
<h3 id="一-serilog基础配置">一 Serilog基础配置</h3>
<ol>
<li>给blazor server添加Serilog相关依赖包。在程序包管理器控制台窗口中输入以下命令</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>    Install-Package Serilog.AspNetCore
</span></span><span style="display:flex;"><span>    Install-Package Serilog.Settings.Configuration
</span></span><span style="display:flex;"><span>    Install-Package Serilog.Sinks.MariaDB
</span></span></code></pre></div><ol start="2">
<li>在数据库中创建用来保存日志的表</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>`logs`<span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>`Id`<span style="color:#bbb"> </span><span style="color:#658b00">bigint</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">NULL</span><span style="color:#bbb"> </span>AUTO_INCREMENT,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>`EventId`<span style="color:#bbb"> </span><span style="color:#658b00">varchar</span>(<span style="color:#b452cd">90</span>)<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>`<span style="color:#8b008b;font-weight:bold">Timestamp</span>`<span style="color:#bbb"> </span>datetime<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>`Message`<span style="color:#bbb"> </span><span style="color:#658b00">text</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>`<span style="color:#8b008b;font-weight:bold">User</span>`<span style="color:#bbb"> </span><span style="color:#658b00">varchar</span>(<span style="color:#b452cd">45</span>)<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>`Ip`<span style="color:#bbb"> </span><span style="color:#658b00">varchar</span>(<span style="color:#b452cd">25</span>)<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>`<span style="color:#8b008b;font-weight:bold">Level</span>`<span style="color:#bbb"> </span><span style="color:#658b00">varchar</span>(<span style="color:#b452cd">15</span>)<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>`<span style="color:#8b008b;font-weight:bold">Exception</span>`<span style="color:#bbb"> </span><span style="color:#658b00">text</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>`MessageTemplate`<span style="color:#bbb"> </span><span style="color:#658b00">text</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>`Properties`<span style="color:#bbb"> </span><span style="color:#658b00">text</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#8b008b;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">KEY</span><span style="color:#bbb"> </span>(`Id`)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span>ENGINE=InnoDB<span style="color:#bbb"> </span>AUTO_INCREMENT=<span style="color:#b452cd">26</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span>CHARSET=utf8mb4<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">COLLATE</span>=utf8mb4_0900_ai_ci;<span style="color:#bbb">
</span></span></span></code></pre></div><ol start="3">
<li>添加Serilog的配置信息</li>
</ol>
<p>因为我们要将日志保存在数据中，所以为了保护数据库连接信息，我们将serilog信息保存在secrets.json文件中。<br>
选择nintens项目，右键弹出菜单中选择 管理用户机密。<br>
在打开的窗口中编辑secrets.json文件，添加以下配置信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#cd5555">&#34;Serilog&#34;</span><span style="color:#a61717;background-color:#e3d2d2">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;Using&#34;</span>: [ <span style="color:#cd5555">&#34;Serilog.Sinks.Console&#34;</span>, <span style="color:#cd5555">&#34;Serilog.Sinks.File&#34;</span>, <span style="color:#cd5555">&#34;Serilog.Sinks.MariaDB&#34;</span> ],
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;Enrich&#34;</span>: [ <span style="color:#cd5555">&#34;FromLogContext&#34;</span>, <span style="color:#cd5555">&#34;WithMachineName&#34;</span>, <span style="color:#cd5555">&#34;WithProcessId&#34;</span>, <span style="color:#cd5555">&#34;WithThreadId&#34;</span> ],
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;MinimumLevel&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#8b008b;font-weight:bold">&#34;Default&#34;</span>: <span style="color:#cd5555">&#34;Debug&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#8b008b;font-weight:bold">&#34;Override&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">&#34;Microsoft&#34;</span>: <span style="color:#cd5555">&#34;Warning&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">&#34;System&#34;</span>: <span style="color:#cd5555">&#34;Warning&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;WriteTo&#34;</span>: [
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">&#34;Name&#34;</span>: <span style="color:#cd5555">&#34;Console&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">&#34;Args&#34;</span>: {
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;outputTemplate&#34;</span>: <span style="color:#cd5555">&#34;{Timestamp:HH:mm:ss} [{Level}] [{EventId:l}] [{User}] [{IP}] {Message}{NewLine}{Exception}&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;restrictedToMinimumLevel&#34;</span>: <span style="color:#cd5555">&#34;Debug&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">&#34;Name&#34;</span>: <span style="color:#cd5555">&#34;File&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">&#34;Args&#34;</span>: {
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;path&#34;</span>: <span style="color:#cd5555">&#34;logs/log.txt&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;outputTemplate&#34;</span>: <span style="color:#cd5555">&#34;{Timestamp:HH:mm:ss.fff zzz} [{User}] [{EventId:l}] [{IP}] [{Level}] [{SourceContext}] [{EventId}] {Message}{NewLine}{Exception}&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;rollOnFileSizeLimit&#34;</span>: <span style="color:#8b008b;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;fileSizeLimitBytes&#34;</span>: <span style="color:#b452cd">4194304</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;retainedFileCountLimit&#34;</span>: <span style="color:#8b008b;font-weight:bold">null</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;rollingInterval&#34;</span>: <span style="color:#cd5555">&#34;Day&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;restrictedToMinimumLevel&#34;</span>: <span style="color:#cd5555">&#34;Debug&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">&#34;Name&#34;</span>: <span style="color:#cd5555">&#34;MariaDB&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">&#34;Args&#34;</span>: {
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;connectionString&#34;</span>: <span style="color:#cd5555">&#34;server=localhost; userid=xxxx;pwd=xxxx;port=3306;database=nintens;Allow Zero Datetime=true;convert zero datetime=True;Character Set=utf8 &#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;autoCreateTable&#34;</span>: <span style="color:#8b008b;font-weight:bold">false</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;tableName&#34;</span>: <span style="color:#cd5555">&#34;Logs&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;restrictedToMinimumLevel&#34;</span>: <span style="color:#cd5555">&#34;Information&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;batchPostingLimit&#34;</span>: <span style="color:#b452cd">200</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;period&#34;</span>: <span style="color:#cd5555">&#34;0.00:00:05&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">&#34;options&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">&#34;PropertiesToColumnsMapping&#34;</span>: {
</span></span><span style="display:flex;"><span>              <span style="color:#8b008b;font-weight:bold">&#34;Exception&#34;</span>: <span style="color:#cd5555">&#34;Exception&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#8b008b;font-weight:bold">&#34;EventId&#34;</span>: <span style="color:#cd5555">&#34;EventId&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#8b008b;font-weight:bold">&#34;Level&#34;</span>: <span style="color:#cd5555">&#34;Level&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#8b008b;font-weight:bold">&#34;Message&#34;</span>: <span style="color:#cd5555">&#34;Message&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#8b008b;font-weight:bold">&#34;MessageTemplate&#34;</span>: <span style="color:#cd5555">&#34;MessageTemplate&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#8b008b;font-weight:bold">&#34;Properties&#34;</span>: <span style="color:#cd5555">&#34;Properties&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#8b008b;font-weight:bold">&#34;Timestamp&#34;</span>: <span style="color:#cd5555">&#34;Timestamp&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#8b008b;font-weight:bold">&#34;User&#34;</span>: <span style="color:#cd5555">&#34;User&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#8b008b;font-weight:bold">&#34;IP&#34;</span>: <span style="color:#cd5555">&#34;IP&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">&#34;TimestampInUtc&#34;</span>: <span style="color:#8b008b;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">&#34;ExcludePropertiesWithDedicatedColumn&#34;</span>: <span style="color:#8b008b;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">&#34;EnumsAsInts&#34;</span>: <span style="color:#8b008b;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">&#34;LogRecordsCleanupFrequency&#34;</span>: <span style="color:#cd5555">&#34;0.02:00:00&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">&#34;LogRecordsExpiration&#34;</span>: <span style="color:#cd5555">&#34;31.00:00:00&#34;</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><ol start="4">
<li>配置信息说明</li>
</ol>
<p>我们添加了三个日志记录存储，分别是Console，文件和数据库。在日志中添加了 &ldquo;FromLogContext&rdquo;, &ldquo;WithMachineName&rdquo;, &ldquo;WithProcessId&rdquo;, &ldquo;WithThreadId&rdquo; 字段。</p>
<p>针对Console类型的日志记录Debug和以上级别的信息。
针对File类型的日志记录Debug和以上级别的信息。
针对Console类型的日志只记录Information和以上级别的信息。</p>
<p>因为保存到MySql数据库，所以我们使用了MariaDB插件，在配置文件中指定了存储的表格，以及表格字段和Serilog中字段的映射关系。
日志保存的时间采用UTC时间，便于不同时区的用户来查看日志。</p>
<p>具体配置信息可以参考Serilog网站的说明。</p>
<ol start="5">
<li>Serilog Serivce配置</li>
</ol>
<p>打开Program.cs文件，在文件中添加以下配置代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span><span style="color:#228b22">//add Serilog Config begin</span>
</span></span><span style="display:flex;"><span>Log.Logger = <span style="color:#8b008b;font-weight:bold">new</span> LoggerConfiguration()
</span></span><span style="display:flex;"><span>    .ReadFrom.Configuration(builder.Configuration)
</span></span><span style="display:flex;"><span>    .CreateLogger();
</span></span><span style="display:flex;"><span>Serilog.Debugging.SelfLog.Enable(Console.Error);
</span></span><span style="display:flex;"><span>builder.Host.UseSerilog();
</span></span><span style="display:flex;"><span><span style="color:#228b22">//add Serilog Config end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">var</span> app = builder.Build();
</span></span></code></pre></div><ol start="6">
<li>记录业务日志</li>
</ol>
<p>打开FetchData.razor文件，在 @Code中添加记录日志代码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>@code {
</span></span><span style="display:flex;"><span><span style="color:#658b00">
</span></span></span><span style="display:flex;"><span><span style="color:#658b00">    [Inject]</span>
</span></span><span style="display:flex;"><span>    ILogger&lt;FetchData&gt; logger { <span style="color:#8b008b;font-weight:bold">get</span>; <span style="color:#8b008b;font-weight:bold">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">private</span> IEnumerable&lt;WeatherForecast&gt; forecasts;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">protected</span> <span style="color:#8b008b;font-weight:bold">override</span> <span style="color:#8b008b;font-weight:bold">async</span> Task OnInitializedAsync()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        forecasts = <span style="color:#8b008b;font-weight:bold">await</span> ForecastService.getWeatherForecasts();
</span></span><span style="display:flex;"><span>        logger.LogInformation(<span style="color:#cd5555">&#34;Fetch Wether Data!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>运行程序，选择FetchData画面。</p>
<p>查看Console日志</p>
<p><img src="/images/logconsole.png" alt="Log Console"></p>
<p>查看文件中的日志<br>
<img src="/images/logfile.png" alt="Log File"></p>
<p>日志内容<br>
<img src="/images/logfile1.png" alt="Log File1"></p>
<p>数据库中的日志<br>
<img src="/images/logdb.png" alt="Log DB"></p>
<h3 id="二-日志记录高级配置扩展logcontext添加user和ip信息">二 日志记录高级配置，扩展logContext，添加User和IP信息</h3>
<p>打开Program.cs文件，添加以下代码，将http请求中的用户信息和IP地址放入到logContext中</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22">//Config logContext Begin</span>
</span></span><span style="display:flex;"><span>app.Use(<span style="color:#8b008b;font-weight:bold">async</span> (httpContext, next) =&gt;
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">//Get username  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#00688b;font-weight:bold">var</span> username = httpContext.User.Identity.IsAuthenticated ? httpContext.User.Identity.Name : <span style="color:#cd5555">&#34;anonymous&#34;</span>;
</span></span><span style="display:flex;"><span>    LogContext.PushProperty(<span style="color:#cd5555">&#34;User&#34;</span>, username);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">//Get remote IP address  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#00688b;font-weight:bold">var</span> ip = httpContext.Connection.RemoteIpAddress.ToString();
</span></span><span style="display:flex;"><span>    LogContext.PushProperty(<span style="color:#cd5555">&#34;IP&#34;</span>, !String.IsNullOrWhiteSpace(ip) ? ip : <span style="color:#cd5555">&#34;unknown&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">await</span> next.Invoke();
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#228b22">//Config logContext End</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... ...
</span></span><span style="display:flex;"><span>app.Run();
</span></span></code></pre></div><p>重新运行程序，选择FetchData画面，查看日志。</p>
<p>数据库中的日志<br>
<img src="/images/logdb1.png" alt="Log DB1"></p>
<h3 id="三-业务日志存储方案">三 业务日志存储方案</h3>
<p>为了方便排查问题，我们需要给日志消息进行编码和命名。</p>
<p>创建一个eventlib项目，添加一个logevent类。 在类中定义要记录的业务日志。
添加Microsoft.Extensions.Logging包的引用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>   Install-Package Microsoft.Extensions.Logging
</span></span></code></pre></div><p>针对不同的业务使用编码区段进行区分。</p>
<p>名字使用两端或者三段进行分割。
三段的名字采用 Domain.Entity.Event 
两端的名字采用 Entity.Event</p>
<p>下面是一个例子</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">logevent</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">static</span> EventId WeatherForecastUpdated = <span style="color:#8b008b;font-weight:bold">new</span> EventId(<span style="color:#b452cd">1001</span>, <span style="color:#cd5555">&#34;WeatherForecast.Updated&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">static</span> EventId WeatherForecastCreated = <span style="color:#8b008b;font-weight:bold">new</span> EventId(<span style="color:#b452cd">1002</span>, <span style="color:#cd5555">&#34;WeatherForecast.Created&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">static</span> EventId WeatherForecastDeleted = <span style="color:#8b008b;font-weight:bold">new</span> EventId(<span style="color:#b452cd">1003</span>, <span style="color:#cd5555">&#34;WeatherForecast.Deleted&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">static</span> EventId WeatherForecastSearched = <span style="color:#8b008b;font-weight:bold">new</span> EventId(<span style="color:#b452cd">1004</span>, <span style="color:#cd5555">&#34;WeatherForecast.Searched&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>打开FetchData.razor文件，修改日志记录代码。记录日志时，添加事件ID。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>@code {
</span></span><span style="display:flex;"><span><span style="color:#658b00">
</span></span></span><span style="display:flex;"><span><span style="color:#658b00">    [Inject]</span>
</span></span><span style="display:flex;"><span>    ILogger&lt;FetchData&gt; logger { <span style="color:#8b008b;font-weight:bold">get</span>; <span style="color:#8b008b;font-weight:bold">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">private</span> IEnumerable&lt;WeatherForecast&gt; forecasts;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">protected</span> <span style="color:#8b008b;font-weight:bold">override</span> <span style="color:#8b008b;font-weight:bold">async</span> Task OnInitializedAsync()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        forecasts = <span style="color:#8b008b;font-weight:bold">await</span> ForecastService.getWeatherForecasts();
</span></span><span style="display:flex;"><span>        logger.LogInformation(logevent.WeatherForecastSearched,<span style="color:#cd5555">&#34;Fetch Wether Data!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>重新运行程序，选择FetchData画面，查看日志。</p>
<p>数据库中的日志<br>
<img src="/images/logdb3.png" alt="log db3"></p>
<h3 id="总结">总结</h3>
<p>至此我们完成了架构中业务日志部分的搭建</p>
<ul>
<li>Serilog基本配置</li>
<li>Serilog logCentext扩展</li>
<li>业务日志记录方案</li>
</ul>
<p>本文地址：<a href="http://www.nintens.com/posts/blazorserver1/">http://www.nintens.com/posts/blazorserver1/</a><br>
作者邮箱：<a href="mailto:liuguanglong@yahoo.com">liuguanglong@yahoo.com</a><br>
欢迎转载，请在明显位置给出出处及链接</p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2022-04-02</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts">
			Next<br>No newer posts.
                </a>
                
                
                
                <a class="older-posts" href="http://www.nintens.com/posts/blazorserver2/">
			Previous<br>使用Blazor Server构建企业级应用(二) -- 使用MudBlazor搭建UI框架
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                


<div id="gitalk-container"></div>









            </div>
        </div>
    </div>


                    </div>
            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Nintens@2022 Copywright
	
</div>
            </div>
    
    <script src="/js/journal.js"></script>
    </body>
</html>
