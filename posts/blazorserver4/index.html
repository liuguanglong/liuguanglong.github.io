<!DOCTYPE html>
<html><head>
<title>使用Blazor Server构建企业级应用(四) -- 添加asp.net Identity用来完成授权和用户权限控制</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">











<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-224238665-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">


  






<link rel="stylesheet" href="http://www.nintens.com/scss/journal.min.3f72a5fc8f5b5dd732a4b476aced0eece2156958d9d414316494ddb10593ddf7.css" integrity="sha256-P3Kl/I9bXdcypLR2rO0O7OIVaVjZ1BQxZJTdsQWT3fc=" media="screen">



<link rel="stylesheet" href="http://www.nintens.com/scss/dark-mode.min.c0082f0b082177f6fb3768ff91439a097de49689bd26f4d49f76d94ebb81e02d.css" integrity="sha256-wAgvCwghd/b7N2j/kUOaCX3klom9JvTUn3bZTruB4C0=" media="screen">


<script src="/vendor/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>






  <script src="/js/toc.js"></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="/vendor/js/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
  clientID: '3231fec73fc43dd4bcc8',
  clientSecret: 'f8ac50ce92aca43790a03f6f576b02fdfe0eb0a8',
  repo: 'nintens.com',
  owner: 'liuguanglong',
  admin: ['liuguanglong'],
  id: md5(location.pathname),
  distractionFreeMode: 'false'
  });
  window.onload = function () {
        gitalk.render('gitalk-container')
  }
</script>











<script>console.log("Hello from 'layouts/partials/extended_head.html'")</script>

</head>
<body>
    	<div id="app"><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="http://www.nintens.com/">
    
        <div class="nav-title">
            Nintens&#39; Blogs 
        </div>
        
        <div class="nav-subtitle">
            应无所住而生其心
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Nintens@2022 Copywright
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bd%bf%e7%94%a8blazor-server%e6%9e%84%e5%bb%ba%e4%bc%81%e4%b8%9a%e7%ba%a7%e5%ba%94%e7%94%a8%e5%9b%9b-%e6%b7%bb%e5%8a%a0aspnet-identity%e7%94%a8%e6%9d%a5%e5%ae%8c%e6%88%90%e6%8e%88%e6%9d%83%e5%92%8c%e7%94%a8%e6%88%b7%e6%9d%83%e9%99%90%e6%8e%a7%e5%88%b6" onclick="onNavClick(`#使用blazor-server构建企业级应用四-添加aspnet-identity用来完成授权和用户权限控制-nav`)" id="使用blazor-server构建企业级应用四-添加aspnet-identity用来完成授权和用户权限控制-nav">
									使用Blazor Server构建企业级应用(四) 添加asp.net Identity用来完成授权和用户权限控制
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%b8%80-%e6%b7%bb%e5%8a%a0aspnet-identity%e4%bd%bf%e7%94%a8%e7%9a%84%e6%95%b0%e6%8d%ae%e5%ba%93%e8%a1%a8" onclick="onNavClick(`#一-添加aspnet-identity使用的数据库表-nav`)" id="一-添加aspnet-identity使用的数据库表-nav">
									一 添加asp.net Identity使用的数据库表
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%ba%8c-%e5%9c%a8%e9%a1%b9%e7%9b%ae%e4%b8%ad%e6%b7%bb%e5%8a%a0aspent-identity%e7%9b%b8%e5%85%b3%e9%85%8d%e7%bd%ae" onclick="onNavClick(`#二-在项目中添加aspent-identity相关配置-nav`)" id="二-在项目中添加aspent-identity相关配置-nav">
									二 在项目中添加asp.ent Identity相关配置
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%b8%89-%e9%85%8d%e7%bd%ae%e5%ba%94%e7%94%a8%e6%9d%83%e9%99%90%e8%a6%81%e6%b1%82%e7%94%a8%e6%88%b7%e7%99%bb%e5%bd%95%e6%89%8d%e8%83%bd%e8%ae%bf%e9%97%ae" onclick="onNavClick(`#三-配置应用权限要求用户登录才能访问-nav`)" id="三-配置应用权限要求用户登录才能访问-nav">
									三 配置应用权限要求用户登录才能访问
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%9b%9b-%e6%b7%bb%e5%8a%a0aspnet-identity%e8%87%aa%e5%b8%a6%e7%9a%84%e5%8a%9f%e8%83%bd%e7%94%bb%e9%9d%a2" onclick="onNavClick(`#四-添加aspnet-identity自带的功能画面-nav`)" id="四-添加aspnet-identity自带的功能画面-nav">
									四 添加asp.net Identity自带的功能画面
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bd%bf%e7%94%a8blazor-server%e6%9e%84%e5%bb%ba%e4%bc%81%e4%b8%9a%e7%ba%a7%e5%ba%94%e7%94%a8%e5%9b%9b-%e6%b7%bb%e5%8a%a0aspnet-identity%e7%94%a8%e6%9d%a5%e5%ae%8c%e6%88%90%e6%8e%88%e6%9d%83%e5%92%8c%e7%94%a8%e6%88%b7%e6%9d%83%e9%99%90%e6%8e%a7%e5%88%b6" onclick="onNavClick(`#使用blazor-server构建企业级应用四-添加aspnet-identity用来完成授权和用户权限控制-nav`)" id="使用blazor-server构建企业级应用四-添加aspnet-identity用来完成授权和用户权限控制-nav">
									使用Blazor Server构建企业级应用(四) 添加asp.net Identity用来完成授权和用户权限控制
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%b8%80-%e6%b7%bb%e5%8a%a0aspnet-identity%e4%bd%bf%e7%94%a8%e7%9a%84%e6%95%b0%e6%8d%ae%e5%ba%93%e8%a1%a8" onclick="onNavClick(`#一-添加aspnet-identity使用的数据库表-nav`)" id="一-添加aspnet-identity使用的数据库表-nav">
									一 添加asp.net Identity使用的数据库表
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%ba%8c-%e5%9c%a8%e9%a1%b9%e7%9b%ae%e4%b8%ad%e6%b7%bb%e5%8a%a0aspent-identity%e7%9b%b8%e5%85%b3%e9%85%8d%e7%bd%ae" onclick="onNavClick(`#二-在项目中添加aspent-identity相关配置-nav`)" id="二-在项目中添加aspent-identity相关配置-nav">
									二 在项目中添加asp.ent Identity相关配置
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%b8%89-%e9%85%8d%e7%bd%ae%e5%ba%94%e7%94%a8%e6%9d%83%e9%99%90%e8%a6%81%e6%b1%82%e7%94%a8%e6%88%b7%e7%99%bb%e5%bd%95%e6%89%8d%e8%83%bd%e8%ae%bf%e9%97%ae" onclick="onNavClick(`#三-配置应用权限要求用户登录才能访问-nav`)" id="三-配置应用权限要求用户登录才能访问-nav">
									三 配置应用权限要求用户登录才能访问
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%9b%9b-%e6%b7%bb%e5%8a%a0aspnet-identity%e8%87%aa%e5%b8%a6%e7%9a%84%e5%8a%9f%e8%83%bd%e7%94%bb%e9%9d%a2" onclick="onNavClick(`#四-添加aspnet-identity自带的功能画面-nav`)" id="四-添加aspnet-identity自带的功能画面-nav">
									四 添加asp.net Identity自带的功能画面
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="http://www.nintens.com/">
            Nintens&#39; Blogs 
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="http://www.nintens.com/">
        <div class="single-column-header-title">Nintens&#39; Blogs </div>
        
        <div class="single-column-header-subtitle">应无所住而生其心</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('http://www.nintens.com/images/chinese.jpg')"
                    
                
            >
                <div class="post-title">
                    使用Blazor Server构建企业级应用(四) -- 添加asp.net Identity用来完成授权和用户权限控制
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2022-04-05 21:25
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/blazor">blazor</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/blazor-server">blazor server</a>
                                &nbsp;
                            
                                <a href="/tags/asp.net-core">asp.net core</a>
                                &nbsp;
                            
                                <a href="/tags/asp.net-identity">asp.net Identity</a>
                                &nbsp;
                            
                                <a href="/tags/blazor-authentication-and-authorization">Blazor authentication and authorization</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h2 id="使用blazor-server构建企业级应用四-添加aspnet-identity用来完成授权和用户权限控制">使用Blazor Server构建企业级应用(四) 添加asp.net Identity用来完成授权和用户权限控制</h2>
<p>本文地址：<a href="http://www.nintens.com/posts/blazorserver4/">http://www.nintens.com/posts/blazorserver4/</a><br>
作者邮箱：<a href="mailto:liuguanglong@yahoo.com">liuguanglong@yahoo.com</a> <br>
欢迎转载，请在明显位置给出出处及链接</p>
<p>本文是nintens架构系列文章的第四篇，包含以下内容</p>
<ul>
<li>添加asp.net Identity使用的数据库表</li>
<li>在项目中添加asp.net Identity相关配置</li>
<li>配置应用权限要求用户登录才能访问</li>
<li>添加asp.net Identity自带的功能画面</li>
</ul>
<h3 id="一-添加aspnet-identity使用的数据库表">一 添加asp.net Identity使用的数据库表</h3>
<ol>
<li>在数据库中创建asp.NET Identity用到的数据库表</li>
</ol>
<p>在mysql中执行Identity.sql添加Identity用到的7张表到nintens数据库<br>
Identity.sql默认会创建Administrators角色，同时会创建一个超级管理员用户 <a href="mailto:liuguanglong@yahoo.com">liuguanglong@yahoo.com</a>，请修改为默认的管理员用户。<br>
这个邮箱会用来获取更新用的密码。创建数据库表请修改。</p>
<p>下载链接: <a href="/images/identity.sql">创建数据库用的Sql文件</a></p>
<ol start="2">
<li>添加用户验证用的DBContext</li>
</ol>
<p>在repository中引入asp.NET Identity相关的包</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>    Install-Package Microsoft.aspNetCore.Identity.EntityFrameworkCore  
</span></span></code></pre></div><p>在repository项目中添加ApplicationDBContext类</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">ApplicationDbContext</span> : IdentityDbContext
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">public</span> ApplicationDbContext(DbContextOptions&lt;ApplicationDbContext&gt; options)
</span></span><span style="display:flex;"><span>            : <span style="color:#8b008b;font-weight:bold">base</span>(options)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h3 id="二-在项目中添加aspent-identity相关配置">二 在项目中添加asp.ent Identity相关配置</h3>
<ol>
<li>nintens项目配置</li>
</ol>
<p>引入asp.NET Identity相关的包</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>    Install-Package Microsoft.aspNetCore.Identity.EntityFrameworkCore  
</span></span><span style="display:flex;"><span>    Install-Package Microsoft.aspNetCore.Identity.UI  
</span></span></code></pre></div><p>在Startup.cs 文件中ConfigureServices函数中添加以下代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>services.AddDbContextPool&lt;ApplicationDbContext&gt;(
</span></span><span style="display:flex;"><span>    options =&gt; options.UseMySql(
</span></span><span style="display:flex;"><span>        connString,
</span></span><span style="display:flex;"><span>        ServerVersion.AutoDetect(connString)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>services.AddDefaultIdentity&lt;IdentityUser&gt;(options =&gt; options.SignIn.RequireConfirmedEmail = <span style="color:#8b008b;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>    .AddRoles&lt;IdentityRole&gt;()
</span></span><span style="display:flex;"><span>    .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;().AddDefaultTokenProviders();
</span></span><span style="display:flex;"><span>services.AddScoped&lt;AuthenticationStateProvider, RevalidatingIdentityAuthenticationStateProvider&lt;IdentityUser&gt;&gt;();
</span></span><span style="display:flex;"><span>services.AddAuthentication(<span style="color:#cd5555">&#34;Identity.Application&#34;</span>).AddCookie();
</span></span></code></pre></div><p>在Program.cs中添加以下代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>app.UseAuthentication();
</span></span><span style="display:flex;"><span>app.UseAuthorization();
</span></span><span style="display:flex;"><span>app.MapRazorPages().RequireAuthorization();
</span></span><span style="display:flex;"><span>app.MapBlazorHub().RequireAuthorization();
</span></span></code></pre></div><ol start="2">
<li>添加错误处理的Component</li>
</ol>
<p>在Shared目录下添加Error.razor</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>@using Microsoft.Extensions.Logging
</span></span><span style="display:flex;"><span>@inject ILogger&lt;Error&gt; Logger
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;CascadingValue Value=<span style="color:#8b008b;font-weight:bold">this</span>&gt;
</span></span><span style="display:flex;"><span>    @ChildContent
</span></span><span style="display:flex;"><span>&lt;/CascadingValue&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@code { 
</span></span><span style="display:flex;"><span><span style="color:#658b00">    [Parameter]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> RenderFragment ChildContent { <span style="color:#8b008b;font-weight:bold">get</span>; <span style="color:#8b008b;font-weight:bold">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">void</span> ProcessError(Exception ex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Logger.LogError(<span style="color:#cd5555">&#34;Error:ProcessError - Type: {Type} Message: {Message}&#34;</span>,
</span></span><span style="display:flex;"><span>            ex.GetType(), ex.Message);
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//StateHasChanged();</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="三-配置应用权限要求用户登录才能访问">三 配置应用权限要求用户登录才能访问</h3>
<ol>
<li>修改App.razor要求用户登录才能访问</li>
</ol>
<p>修改_Imports.razor添加以下代码注入NavigationManager</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>@inject NavigationManager NavigationManager
</span></span></code></pre></div><p>将原来的代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>    &lt;Router AppAssembly=<span style="color:#cd5555">&#34;@typeof(App).Assembly&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;Found Context=<span style="color:#cd5555">&#34;routeData&#34;</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;RouteView RouteData=<span style="color:#cd5555">&#34;@routeData&#34;</span> DefaultLayout=<span style="color:#cd5555">&#34;@typeof(MainLayout)&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>            &lt;FocusOnNavigate RouteData=<span style="color:#cd5555">&#34;@routeData&#34;</span> Selector=<span style="color:#cd5555">&#34;h1&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>        &lt;/Found&gt;
</span></span><span style="display:flex;"><span>        &lt;NotFound&gt;
</span></span><span style="display:flex;"><span>            &lt;PageTitle&gt;Not found&lt;/PageTitle&gt;
</span></span><span style="display:flex;"><span>            &lt;LayoutView Layout=<span style="color:#cd5555">&#34;@typeof(MainLayout)&#34;</span>&gt;
</span></span><span style="display:flex;"><span>                &lt;p role=<span style="color:#cd5555">&#34;alert&#34;</span>&gt;Sorry, there<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>s nothing at <span style="color:#8b008b;font-weight:bold">this</span> address.&lt;/p&gt;
</span></span><span style="display:flex;"><span>            &lt;/LayoutView&gt;
</span></span><span style="display:flex;"><span>        &lt;/NotFound&gt;
</span></span><span style="display:flex;"><span>    &lt;/Router&gt;
</span></span></code></pre></div><p>改为</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>&lt;Error&gt;
</span></span><span style="display:flex;"><span>    &lt;Router AppAssembly=<span style="color:#cd5555">&#34;@typeof(App).Assembly&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;Found Context=<span style="color:#cd5555">&#34;routeData&#34;</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;AuthorizeRouteView RouteData=<span style="color:#cd5555">&#34;@routeData&#34;</span> DefaultLayout=<span style="color:#cd5555">&#34;@typeof(MainLayout)&#34;</span>&gt;
</span></span><span style="display:flex;"><span>                &lt;NotAuthorized&gt;
</span></span><span style="display:flex;"><span>                    <span style="color:#a61717;background-color:#e3d2d2">@</span>{ NavigationManager.NavigateTo(<span style="color:#cd5555">&#34;/login&#34;</span>); }
</span></span><span style="display:flex;"><span>                &lt;/NotAuthorized&gt;
</span></span><span style="display:flex;"><span>             &lt;/AuthorizeRouteView&gt;
</span></span><span style="display:flex;"><span>        &lt;/Found&gt;
</span></span><span style="display:flex;"><span>        &lt;NotFound&gt;
</span></span><span style="display:flex;"><span>            &lt;PageTitle&gt;Not found&lt;/PageTitle&gt;
</span></span><span style="display:flex;"><span>            &lt;LayoutView Layout=<span style="color:#cd5555">&#34;@typeof(MainLayout)&#34;</span>&gt;
</span></span><span style="display:flex;"><span>                &lt;p role=<span style="color:#cd5555">&#34;alert&#34;</span>&gt;Sorry, there<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>s nothing at <span style="color:#8b008b;font-weight:bold">this</span> address.&lt;/p&gt;
</span></span><span style="display:flex;"><span>            &lt;/LayoutView&gt;
</span></span><span style="display:flex;"><span>        &lt;/NotFound&gt;
</span></span><span style="display:flex;"><span>    &lt;/Router&gt;
</span></span><span style="display:flex;"><span>&lt;/Error&gt;
</span></span></code></pre></div><p>项目要求用户登录才能访问，否则自动转移到登录画面</p>
<h3 id="四-添加aspnet-identity自带的功能画面">四 添加asp.net Identity自带的功能画面</h3>
<ol>
<li>复制asp.NET Identity相关的UI画面代码到nintens项目下</li>
</ol>
<p>将Areas文件解压放到 nintens工程下<br>
下载链接: <a href="/images/Areas.zip">Identity功能页面</a></p>
<p><img src="/images/IdentityFiles.png" alt="IdentityFiles"></p>
<p>将Shared文件解压后放到 Pages目录下<br>
下载链接: <a href="/images/Shared.zip">IdentityLayout页面</a><br>
<img src="/images/IdentityFile2.png" alt="IdentityFile2"></p>
<ol start="2">
<li>添加发送邮件的服务，用来获取密码重置等服务。</li>
</ol>
<p>在Startup.cs中注入EmailService</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>services.AddTransient&lt;IEmailSender, EmailSender&gt;(i =&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">new</span> EmailSender(
</span></span><span style="display:flex;"><span>        Configuration[<span style="color:#cd5555">&#34;EmailSender:Host&#34;</span>],
</span></span><span style="display:flex;"><span>        Configuration.GetValue&lt;<span style="color:#00688b;font-weight:bold">int</span>&gt;(<span style="color:#cd5555">&#34;EmailSender:Port&#34;</span>),
</span></span><span style="display:flex;"><span>        Configuration.GetValue&lt;<span style="color:#00688b;font-weight:bold">bool</span>&gt;(<span style="color:#cd5555">&#34;EmailSender:EnableSSL&#34;</span>),
</span></span><span style="display:flex;"><span>        Configuration[<span style="color:#cd5555">&#34;EmailSender:UserName&#34;</span>],
</span></span><span style="display:flex;"><span>        Configuration[<span style="color:#cd5555">&#34;EmailSender:Password&#34;</span>]
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>将配置信息放入到客户端机密存储</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JSON" data-lang="JSON"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;EmailSender&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;Host&#34;</span>: <span style="color:#cd5555">&#34;smtp.office365.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;Port&#34;</span>: <span style="color:#b452cd">587</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;EnableSSL&#34;</span>: <span style="color:#8b008b;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;UserName&#34;</span>: <span style="color:#cd5555">&#34;xxxx@xxxxx.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;Password&#34;</span>: <span style="color:#cd5555">&#34;xxxxxxxx&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="3">
<li>启动应用</li>
</ol>
<p>画面自动转向到login画面</p>
<p><img src="/images/Identitylogin.png" alt="IdentityLogin"></p>
<p>点击Forgot your password重置密码后，既可以登录访问应用。</p>
<ol start="4">
<li>添加 logout功能<br>
打开 LoginDisplay.razor页面，修改Logout menu,添加url转向Logout页面。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span>&lt;MudMenuItem Style=<span style="color:#cd5555">&#34;height:25px;width:100px;&#34;</span>&gt;&lt;MudLink Href=<span style="color:#cd5555">&#34;Identity/Account/LogOut&#34;</span>&gt;Logout&lt;/MudLink&gt;&lt;/MudMenuItem&gt; 
</span></span></code></pre></div><p>至此我们搭建了基于asp.net Identity的用户管理和权限控制框架，完成了以下任务</p>
<ul>
<li>添加asp.net Identity使用的数据库表</li>
<li>在项目中添加asp.net Identity相关配置</li>
<li>配置应用权限要求用户登录才能访问</li>
<li>添加asp.net Identity自带的功能画面</li>
</ul>
<p>下一章我们会讲解如何修改asp.net Identity自带的管理端画面</p>
<p>本文地址：<a href="http://www.nintens.com/posts/blazorserver4/">http://www.nintens.com/posts/blazorserver4/</a><br>
作者邮箱：<a href="mailto:liuguanglong@yahoo.com">liuguanglong@yahoo.com</a> <br>
欢迎转载，请在明显位置给出出处及链接</p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2022-04-05</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="http://www.nintens.com/posts/blazorserver5/">
			Next<br>使用Blazor Server构建企业级应用(五) -- 使用asp.net Identity完成功能的权限控制
                </a>
                
                
                
                <a class="older-posts" href="http://www.nintens.com/posts/blazorserver3/">
			Previous<br>使用Blazor Server构建企业级应用(三) -- 使用Serilog记录和显示业务日志
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                


<div id="gitalk-container"></div>









            </div>
        </div>
    </div>


                    </div>
            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Nintens@2022 Copywright
	
</div>
            </div>
    
    <script src="/js/journal.js"></script>
    </body>
</html>
