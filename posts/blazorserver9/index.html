<!DOCTYPE html>
<html><head>
<title>使用Blazor Server构建企业级应用(九) -- Linux下的Docker部署</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">











<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-224238665-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">


  






<link rel="stylesheet" href="http://www.nintens.com/scss/journal.min.3f72a5fc8f5b5dd732a4b476aced0eece2156958d9d414316494ddb10593ddf7.css" integrity="sha256-P3Kl/I9bXdcypLR2rO0O7OIVaVjZ1BQxZJTdsQWT3fc=" media="screen">



<link rel="stylesheet" href="http://www.nintens.com/scss/dark-mode.min.c0082f0b082177f6fb3768ff91439a097de49689bd26f4d49f76d94ebb81e02d.css" integrity="sha256-wAgvCwghd/b7N2j/kUOaCX3klom9JvTUn3bZTruB4C0=" media="screen">


<script src="/vendor/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>






  <script src="/js/toc.js"></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="/vendor/js/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
  clientID: '3231fec73fc43dd4bcc8',
  clientSecret: 'f8ac50ce92aca43790a03f6f576b02fdfe0eb0a8',
  repo: 'nintens.com',
  owner: 'liuguanglong',
  admin: ['liuguanglong'],
  id: md5(location.pathname),
  distractionFreeMode: 'false'
  });
  window.onload = function () {
        gitalk.render('gitalk-container')
  }
</script>











<script>console.log("Hello from 'layouts/partials/extended_head.html'")</script>

</head>
<body>
    	<div id="app"><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="http://www.nintens.com/">
    
        <div class="nav-title">
            Nintens&#39; Blogs 
        </div>
        
        <div class="nav-subtitle">
            应无所住而生其心
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Nintens@2022 Copywright
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bd%bf%e7%94%a8blazor-server%e6%9e%84%e5%bb%ba%e4%bc%81%e4%b8%9a%e7%ba%a7%e5%ba%94%e7%94%a8%e4%b9%9d----linux%e4%b8%8b%e7%9a%84docker%e9%83%a8%e7%bd%b2" onclick="onNavClick(`#使用blazor-server构建企业级应用九----linux下的docker部署-nav`)" id="使用blazor-server构建企业级应用九----linux下的docker部署-nav">
									使用Blazor Server构建企业级应用(九) – Linux下的Docker部署
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%b8%80-docker%e8%87%aa%e5%8a%a8%e5%8c%96%e6%89%93%e5%8c%85" onclick="onNavClick(`#一-docker自动化打包-nav`)" id="一-docker自动化打包-nav">
									一 Docker自动化打包
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%ba%8c--%e5%9f%ba%e4%ba%8edocker-compose%e7%9a%84blazor%e5%ba%94%e7%94%a8%e5%8f%91%e5%b8%83" onclick="onNavClick(`#二--基于docker-compose的blazor应用发布-nav`)" id="二--基于docker-compose的blazor应用发布-nav">
									二 基于Docker-Compose的Blazor应用发布
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%80%bb%e7%bb%93" onclick="onNavClick(`#总结-nav`)" id="总结-nav">
									总结
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bd%bf%e7%94%a8blazor-server%e6%9e%84%e5%bb%ba%e4%bc%81%e4%b8%9a%e7%ba%a7%e5%ba%94%e7%94%a8%e4%b9%9d----linux%e4%b8%8b%e7%9a%84docker%e9%83%a8%e7%bd%b2" onclick="onNavClick(`#使用blazor-server构建企业级应用九----linux下的docker部署-nav`)" id="使用blazor-server构建企业级应用九----linux下的docker部署-nav">
									使用Blazor Server构建企业级应用(九) – Linux下的Docker部署
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%b8%80-docker%e8%87%aa%e5%8a%a8%e5%8c%96%e6%89%93%e5%8c%85" onclick="onNavClick(`#一-docker自动化打包-nav`)" id="一-docker自动化打包-nav">
									一 Docker自动化打包
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%ba%8c--%e5%9f%ba%e4%ba%8edocker-compose%e7%9a%84blazor%e5%ba%94%e7%94%a8%e5%8f%91%e5%b8%83" onclick="onNavClick(`#二--基于docker-compose的blazor应用发布-nav`)" id="二--基于docker-compose的blazor应用发布-nav">
									二 基于Docker-Compose的Blazor应用发布
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%80%bb%e7%bb%93" onclick="onNavClick(`#总结-nav`)" id="总结-nav">
									总结
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="http://www.nintens.com/">
            Nintens&#39; Blogs 
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="http://www.nintens.com/">
        <div class="single-column-header-title">Nintens&#39; Blogs </div>
        
        <div class="single-column-header-subtitle">应无所住而生其心</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('http://www.nintens.com/images/chinese.jpg')"
                    
                
            >
                <div class="post-title">
                    使用Blazor Server构建企业级应用(九) -- Linux下的Docker部署
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2022-05-01 23:25
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/blazor">blazor</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/blazor-server">blazor server</a>
                                &nbsp;
                            
                                <a href="/tags/asp.net-core">asp.net core</a>
                                &nbsp;
                            
                                <a href="/tags/linux">linux</a>
                                &nbsp;
                            
                                <a href="/tags/docker">docker</a>
                                &nbsp;
                            
                                <a href="/tags/deploy">deploy</a>
                                &nbsp;
                            
                                <a href="/tags/docker-compose">docker-compose</a>
                                &nbsp;
                            
                                <a href="/tags/azure-devops">azure devops</a>
                                &nbsp;
                            
                                <a href="/tags/azure-container-registry">Azure Container Registry</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h2 id="使用blazor-server构建企业级应用九----linux下的docker部署">使用Blazor Server构建企业级应用(九) &ndash; Linux下的Docker部署</h2>
<p>本文地址：<a href="http://www.nintens.com/posts/blazorserver9/">http://www.nintens.com/posts/blazorserver9/</a><br>
作者邮箱：<a href="mailto:liuguanglong@yahoo.com">liuguanglong@yahoo.com</a><br>
欢迎转载，请在明显位置给出出处及链接</p>
<p>本文是nintens架构系列文章的第九篇，包含以下内容</p>
<ul>
<li>Docker自动化打包</li>
<li>基于Docker-Compose的Blazor应用发布</li>
</ul>
<h3 id="一-docker自动化打包">一 Docker自动化打包</h3>
<ol>
<li>添加Docker支持</li>
</ol>
<p>选择 Balzor项目-&gt;右键 添加-&gt; Docker支持 -&gt; 目标OS: Linux
在项目文件夹目录会生成Dockerfile
为了支持SSL，在Dockerfile中添加开放443端口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#228b22">#See https://aka.ms/containerfastmode to understand how Visual Studio uses this Dockerfile to build your images for faster debugging.</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">FROM</span><span style="color:#cd5555"> mcr.microsoft.com/dotnet/aspnet:6.0 AS base</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">WORKDIR</span><span style="color:#cd5555"> /app</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">EXPOSE</span><span style="color:#cd5555"> 80</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">EXPOSE</span><span style="color:#cd5555"> 443</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">FROM</span><span style="color:#cd5555"> mcr.microsoft.com/dotnet/sdk:6.0 AS build</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">WORKDIR</span><span style="color:#cd5555"> /src</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">COPY</span> [<span style="color:#cd5555">&#34;pgoplusconnectorportal/pgoplusconnectorportal.csproj&#34;</span>, <span style="color:#cd5555">&#34;pgoplusconnectorportal/&#34;</span>]<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">COPY</span> [<span style="color:#cd5555">&#34;service/service.csproj&#34;</span>, <span style="color:#cd5555">&#34;service/&#34;</span>]<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">COPY</span> [<span style="color:#cd5555">&#34;repository/repository.csproj&#34;</span>, <span style="color:#cd5555">&#34;repository/&#34;</span>]<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">COPY</span> [<span style="color:#cd5555">&#34;modal/modal.csproj&#34;</span>, <span style="color:#cd5555">&#34;modal/&#34;</span>]<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">COPY</span> [<span style="color:#cd5555">&#34;eventlib/eventlib.csproj&#34;</span>, <span style="color:#cd5555">&#34;eventlib/&#34;</span>]<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> dotnet restore <span style="color:#cd5555">&#34;pgoplusconnectorportal/pgoplusconnectorportal.csproj&#34;</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">COPY</span> . .<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">WORKDIR</span><span style="color:#cd5555"> &#34;/src/pgoplusconnectorportal&#34;</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> dotnet build <span style="color:#cd5555">&#34;pgoplusconnectorportal.csproj&#34;</span> -c Release -o /app/build<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">FROM</span><span style="color:#cd5555"> build AS publish</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> dotnet publish <span style="color:#cd5555">&#34;pgoplusconnectorportal.csproj&#34;</span> -c Release -o /app/publish<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">FROM</span><span style="color:#cd5555"> base AS final</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">WORKDIR</span><span style="color:#cd5555"> /app</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">COPY</span> --from=publish /app/publish .<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">ENTRYPOINT</span> [<span style="color:#cd5555">&#34;dotnet&#34;</span>, <span style="color:#cd5555">&#34;pgoplusconnectorportal.dll&#34;</span>]<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span></code></pre></div><ol start="2">
<li>使用azure devops自动化Build DockerImage</li>
</ol>
<ul>
<li>在Azure devops中创建一个新的PipleLine，代码选择 Azure Repos Git <br>
<img src="/images/pipeline1.png" alt="pipeline1"></li>
<li>选择要Build的项目，Build的类型   Docker-Build and push an image to Azure Container Registry<br>
<img src="/images/pipeline2.png" alt="pipeline2"></li>
<li>选择 Azure Conatiner Registry项目</li>
</ul>
<p>保存后会在工程目录下添加了自动生成的 azure-pipeLines.yml文件</p>
<p>在azure-pipelines.yml文件中添加BuildContext相关配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#8b008b;font-weight:bold">task</span>:<span style="color:#bbb"> </span>Docker@2<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#8b008b;font-weight:bold">displayName</span>:<span style="color:#bbb"> </span>Build and push an image to container registry<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#8b008b;font-weight:bold">inputs</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">command</span>:<span style="color:#bbb"> </span>buildAndPush<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">repository</span>:<span style="color:#bbb"> </span>$(imageRepository)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">dockerfile</span>:<span style="color:#bbb"> </span>$(dockerfilePath)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">buildContext</span>:<span style="color:#bbb">  </span>$(Build.Repository.LocalPath)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">containerRegistry</span>:<span style="color:#bbb"> </span>$(dockerRegistryServiceConnection)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">tags</span>:<span style="color:#bbb"> </span>|<span style="color:#cd5555">
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">          </span><span style="color:#bbb">          </span>$(tag)<span style="color:#bbb">
</span></span></span></code></pre></div><p>修改后，以后每次master有新的commit后会自动构建dockerimage保存在 Azure Container Registry中</p>
<p><img src="/images/pipeline3.png" alt="pipeline3"></p>
<h3 id="二--基于docker-compose的blazor应用发布">二  基于Docker-Compose的Blazor应用发布</h3>
<ol>
<li>添加docker-compose配置</li>
</ol>
<p>选择 项目-&gt;右键 添加-&gt;容器业务流程协调程序支持 -&gt; 目标OS: Linux<br>
在工程目录下会生成docker-compose.yml 和 docker-compose.override.yml 配置文件</p>
<ol start="2">
<li>添加数据库相关配置</li>
</ol>
<p>修改docker-compose.yml, 添加虚拟网络环境配置 <br>
修改docker-compose.yml, 添加数据库相关的配置</p>
<p>修改的内容参考注释</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#cd5555">&#39;3.4&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#8b008b;font-weight:bold">pgoplusconnectorportal</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">image</span>:<span style="color:#bbb"> </span>xxxxxx.azurecr.io/pgoplusconnectorportal:1124  <span style="color:#bbb"> </span><span style="color:#228b22">#Azure Container Registry地址/Docker Image名:版本号</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">container_name</span>:<span style="color:#bbb"> </span>pgoplusconnectorportal<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>- pgoconnector  <span style="color:#bbb"> </span><span style="color:#228b22">#需要用到的网络环境，应用和数据库需要在一个虚拟网络环境</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">environment</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span>- ASPNETCORE_URLS=http://+:80<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#cd5555">&#34;31040:80&#34;</span><span style="color:#bbb">        </span><span style="color:#228b22">#将80端口映射到服务器的31040端口</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">dns</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#b452cd">8.8.8.8</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#b452cd">4.4.4.4</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#b452cd">192.168.1.8</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">depends_on</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- pgoconnectordb   <span style="color:#bbb"> </span><span style="color:#228b22">#应用需要使用的数据库</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#8b008b;font-weight:bold">pgoconnectordb</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span><span style="color:#8b008b;font-weight:bold">image</span>:<span style="color:#bbb"> </span>mysql:8.0.21 <span style="color:#bbb"> </span><span style="color:#228b22">#使用mysql的版本为 8.0.21</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span><span style="color:#8b008b;font-weight:bold">container_name</span>:<span style="color:#bbb"> </span>pgoconnectordb<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span><span style="color:#8b008b;font-weight:bold">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>- <span style="color:#b452cd">33316</span>:<span style="color:#b452cd">3306</span><span style="color:#bbb">      </span><span style="color:#228b22">#将docker中的默认3306端口映射到服务器的33316端口 </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span><span style="color:#8b008b;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>- pgoconnector   <span style="color:#bbb"> </span><span style="color:#228b22">#需要用到的网络环境，应用和数据库需要在一个虚拟网络环境</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">environment</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#8b008b;font-weight:bold">MYSQL_ROOT_PASSWORD</span>:<span style="color:#bbb"> </span>xxxxx       <span style="color:#bbb"> </span><span style="color:#228b22">#设置mysql的root密码</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#8b008b;font-weight:bold">MYSQL_DATABAE</span>:<span style="color:#bbb"> </span>connectorportal   <span style="color:#bbb"> </span><span style="color:#228b22">#数据库的Schema名</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#8b008b;font-weight:bold">MYSQL_USER</span>:<span style="color:#bbb"> </span>xxxxxxxxxx           <span style="color:#bbb"> </span><span style="color:#228b22">#数据库的用户名 </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#8b008b;font-weight:bold">MYSQL_PASSWORD</span>:<span style="color:#bbb"> </span>xxxxxxxxx        <span style="color:#bbb"> </span><span style="color:#228b22">#数据库用户密码</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span><span style="color:#8b008b;font-weight:bold">command</span>:<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>--default-authentication-plugin=mysql_native_password<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>--character-set-server=utf8mb4<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>--collation-server=utf8mb4_general_ci<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>--explicit_defaults_for_timestamp=true<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>--lower_case_table_names=1<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span><span style="color:#8b008b;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>- ./data:/var/lib/mysql  <span style="color:#bbb"> </span><span style="color:#228b22">#设置docker-compose所在目录下的data子目录来保存mysql的数据文件             </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>- ./script/1.sql:/docker-entrypoint-initdb.d/1.sql  <span style="color:#bbb"> </span><span style="color:#228b22">#使用docker-compose所在目录下script子目录下的1.sql来初始化数据库  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span><span style="color:#8b008b;font-weight:bold">restart</span>:<span style="color:#bbb"> </span>always<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#8b008b;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span><span style="color:#8b008b;font-weight:bold">pgoconnector</span>:<span style="color:#bbb">     </span><span style="color:#228b22">#配置虚拟化网络环境   </span><span style="color:#bbb">
</span></span></span></code></pre></div><ol start="3">
<li>部署环境软件准备</li>
</ol>
<ul>
<li>安装 Azure CLI</li>
<li>安装docker</li>
<li>安装docker-compose</li>
<li>安装 Dotnet Core SDK</li>
</ul>
<ol start="4">
<li>添加asp.net ssl验证相关配置</li>
</ol>
<p>在当前用户环境下创建asp.net运行需要的环境<br>
例如当前用户名为 azureuser</p>
<p>在/home/azureuser目录下执行以下命令来生成开发用的自签名SSL证书</p>
<pre tabindex="0"><code>cd ~
mkdir .aspnet
cd .aspnet
mkdir https

sudo dotnet dev-certs https -v -ep ${HOME}/.aspnet/https/pgoplusconnectorportal.pfx  -p xxxxxxxxxxxxxxxx
sudo dotnet dev-certs https --trust
</code></pre><ol start="5">
<li>添加运行环境下的user secrets配置</li>
</ol>
<p>执行以下命令来创建应用使用的user secrets配置文件</p>
<pre tabindex="0"><code>cd ~
mkdir .microsoft
cd .microsoft
mkdir usersecrets
cd usersecrets
mkdir B240BB2A-525C-421A-BB53-7F0E9DE5FF13
cd B240BB2A-525C-421A-BB53-7F0E9DE5FF13
</code></pre><p>B240BB2A-525C-421A-BB53-7F0E9DE5FF13是项目的UserSecretsId,可以通过查看项目的csproj获得。<br>
<img src="/images/docker1.png" alt="docker1"></p>
<p>复制本机开发环境的secrets.json文件到 B240BB2A-525C-421A-BB53-7F0E9DE5FF13 文件夹下</p>
<p>修改secrets.json文件中的数据库连接信息，保持跟docker-compose中数据库的配置信息一致。<br>
server的名字要跟mysql的 container名一致， database要跟mysql的MYSQL_DATABAE保持一致</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">&#34;ConnectionStrings&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;Product&#34;</span>: <span style="color:#cd5555">&#34;server=pgoconnectordb; userid=xxxxx;pwd=xxxxxx;port=3306;database=connectorportal;Allow Zero Datetime=true;convert zero datetime=True;Character Set=utf8 &#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a61717;background-color:#e3d2d2">...</span> <span style="color:#a61717;background-color:#e3d2d2">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="6">
<li>配置asp.net运行环境<br>
修改docker-compose.overide.yml配置asp.net相关的配置<br>
修改的配置参考注释</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#cd5555">&#39;3.4&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#8b008b;font-weight:bold">pgoplusconnectorportal</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">environment</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- ASPNETCORE_ENVIRONMENT=Development           <span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- ASPNETCORE_URLS=https://+:443;http://+:80     <span style="color:#bbb"> </span><span style="color:#228b22">#配置应用开放端口，包括http和https   </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- ASPNETCORE_Kestrel__Certificates__Default__Path=/https/pgoplusconnectorportal.pfx   <span style="color:#bbb"> </span><span style="color:#228b22">#配置SSL使用的证书</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- ASPNETCORE_Kestrel__Certificates__Default__Password=xxxxxxxxxxxxxxxx                <span style="color:#bbb"> </span><span style="color:#228b22">#配置SSL证书密码</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#cd5555">&#34;31040:80&#34;</span><span style="color:#bbb">      </span><span style="color:#228b22">#将docker内的80端口映射到服务器的31040端口</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#cd5555">&#34;31050:443&#34;</span><span style="color:#bbb">     </span><span style="color:#228b22">#将docker内的442端口映射到服务器的31050端口</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- ~/.microsoft/usersecrets:/root/.microsoft/usersecrets:ro  <span style="color:#bbb"> </span><span style="color:#228b22">#将usersercrets目录映射到docker内对应目录</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- ~/pgo-connectorportal/aspnetkeys:/var/aspnetkeys:rw       <span style="color:#bbb"> </span><span style="color:#228b22">#将应用部署目录下的aspnetkeys目录映射到docker内的对应目录，用来保存key</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- ~/.aspnet/https:/https:ro  <span style="color:#bbb"> </span><span style="color:#228b22">#将证书目录映射到docker内对应目录   </span><span style="color:#bbb">
</span></span></span></code></pre></div><ol start="7">
<li>准备数据库初始化脚本
使用Mysql WorkBench的Data Export功能生成数据库的初始化脚本。<br>
需要保证创建的schema名字跟docker中mysql配置的名字一致。</li>
</ol>
<p>将生成的文件改名为1.sql，放到部署目录下的script目录下。</p>
<ol start="8">
<li>使用Docker-Compose Deploy运行环境</li>
</ol>
<ul>
<li>将docker-compose.yml  docker-compose.override.yml两个文件复制到部署目录。</li>
<li>登陆Azure<br>
az login -u <a href="mailto:xxx@xxxxx.com">xxx@xxxxx.com</a></li>
<li>登陆Azure Container Registry<br>
az acr login &ndash;name xxxxx</li>
<li>拉去Docker Images<br>
docker-compose pull</li>
<li>运行应用<br>
docker-compose up -d</li>
</ul>
<h3 id="总结">总结</h3>
<p>本文是至此我们完成了Linux环境中基于Docker的程序打包和发布，实现了以下功能</p>
<ul>
<li>Docker自动化打包</li>
<li>基于Docker-Compose的Blazor应用发布</li>
</ul>
<p>本文地址：<a href="http://www.nintens.com/posts/blazorserver8/">http://www.nintens.com/posts/blazorserver8/</a><br>
作者邮箱：<a href="mailto:liuguanglong@yahoo.com">liuguanglong@yahoo.com</a><br>
欢迎转载，请在明显位置给出出处及链接</p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2022-05-01</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts">
			Next<br>No newer posts.
                </a>
                
                
                
                <a class="older-posts" href="http://www.nintens.com/posts/blazorserver8/">
			Previous<br>使用Blazor Server构建企业级应用(八) -- 画面的本地化
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                


<div id="gitalk-container"></div>









            </div>
        </div>
    </div>


                    </div>
            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Nintens@2022 Copywright
	
</div>
            </div>
    
    <script src="/js/journal.js"></script>
    </body>
</html>
